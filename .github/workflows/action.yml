name: iOS Simulator Test

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  run-ios-simulator-tests:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Xcode and iOS Simulator
        run: |
          sudo xcode-select --switch /Applications/Xcode.app

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: "16"

      - name: Cache npm global packages
        uses: actions/cache@v3
        with:
          path: ~/.npm-global
          key: ${{ runner.os }}-npm-global-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-global-

      - name: Set npm global packages path
        run: |
          echo "NPM_CONFIG_PREFIX=~/.npm-global" >> $GITHUB_ENV
          echo "$HOME/.npm-global/bin" >> $GITHUB_PATH

      - name: Start Appium Server
        run: |
          appium driver install xcuitest
          appium --base-path=/wd/hub -p 4723 &

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: "3.x"

      - name: Cache Python packages
        uses: actions/cache@v3
        with:
          # Cache location for pip
          path: ~/.cache/pip
          # Generate a unique key based on OS, Python version, and requirements.txt
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          # Use a partial key to restore similar caches if an exact match isn't found
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Boot iOS Simulator
        run: xcrun simctl boot "B8B4F5F1-B485-4B84-8698-BCD628736511"

      - name: check if simu is running
        run: xcrun simctl list devices

      - name: Run the test
        run: |
          robot testcases/ios.robot

      - run: ls -l
